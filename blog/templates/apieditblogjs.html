{% extends "base.html" %}
{% load static %}

{% block title %}edit JS{% endblock title %}
{% block content %}
    edit JS

    {#<div><a href="{% url 'blog:blogs_list' %}"><span>Главная</span></a></div>#}
    <div class=" d-flex justify-content-center">
        <form enctype="multipart/form-data" class="needs-validation" novalidate>
            <div class=" d-flex justify-content-center">
                <div class=" d-flex flex-column m-5">
                    <label for="validationCustom03" class="form-label">Название</label>
                    <input class="form-control col-6 col-sm-5 col-md-4 col-lg-3 col-xl-12  mt-2 mb-2" type="text" name="publish_title" value="{{ post_ditail.title }}"  id="validationTooltip01" aria-describedby="inputGroupPrepend"  required>
                    <div class="invalid-feedback invalid-feedback-file">
                        Введите название
                    </div>
                    <label for="validationCustom02" class="form-label mt-2">Подробно</label>
                    <textarea type="text" class="form-control mb-2"  name="publish_text" id="validationTextarea" required>{{ post_ditail.text }}</textarea>
                    <div class="invalid-feedback">
                        Введите текст
                    </div>
                    <input class="col-6 col-sm-5 col-md-4 col-lg-3 col-xl-12 mt-2 mb-2" type="file" name="publish_photo"><a href="{{ MEDIA_URL }}{{ post_ditail.photo }}">{{ post_ditail.photo }}</a>
                    <input class="col-6 col-sm-5 col-md-4 col-lg-3 col-xl-12 mt-2 mb-2" type="button" onclick="handleFiles({{ post_ditail.pk }})" value="Сохранить запись">
                </div>
            </div>
        </form>
    </div>

    <script>

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function editeGist (idpost){

            //alert(idpost)
            var publish_author = 'default'
            var publish_title = document.getElementsByName('publish_title')[0].value
            var publish_text = document.getElementsByName('publish_text')[0].value
            let pk = idpost
            let csrftoken = getCookie('csrftoken');
            const formData = new FormData();
            const fileField = document.querySelector('input[type="file"]');
            console.log('photo')
            console.log(fileField.files[0])
            formData.append('author', publish_author);
            formData.append('title', publish_title);
            formData.append('text', publish_text);
            formData.append('photo', fileField.files[0]);
            console.log('formData')
            console.log(formData)
            /*fetch("http://127.0.0.1:8991/api/posts/" + pk, {
                method: "put",
                credentials: "same-origin",
                headers: {
                    "X-CSRFToken": csrftoken,
                },
                body: formData
            })*/
            try {
                const response = await fetch("http://127.0.0.1:8991/api/posts/" + pk, {
                    method: 'PUT',
                    credentials: "same-origin",
                    headers: {
                        'Content-type': 'application/json; charset=UTF-8',
                        "X-CSRFToken": csrftoken,
                    },
                    body: formData
                });
                const result = await response.json();
                console.log('Успех:', JSON.stringify(result));
                if (result.res == '0'){
                    console.log('введены не все данные')
                    console.log(result)
                }else{
                    location.href = 'http://127.0.0.1:8991/blog/apidetailblogjs/' + pk
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }
            /*.then(function (response) {
                {#console.log('response.json()')#}
                if (response){
                    console.log('response')
                    console.log(response.text())
                   {#location.href = 'http://127.0.0.1:8991/blog/apidetailblogjs/' + pk#}
                }
            })*/
            {#.then(data=>console.log(data.json()))#}
            {#.then(data1=>console.log(data1))#}
        }

        // Пример стартового JavaScript для отключения отправки форм при наличии недопустимых полей
        function handleFiles(idpost) {
            'use strict'
            // Получите все формы, к которым мы хотим применить пользовательские стили проверки Bootstrap   handleFiles()
            var forms = document.querySelectorAll('.needs-validation')
            // Зацикливайтесь на них и предотвращайте отправку
            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        if (!form.checkValidity()) {
                            event.preventDefault()
                            event.stopPropagation()
                        }
                        form.classList.add('was-validated')
                        console.log('idpost')
                        console.log(idpost)
                        editeGist(idpost)
                    }, false)
                })
        }


    </script>
{% endblock content %}